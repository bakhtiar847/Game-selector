<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Selector</title>
  <style>
    :root{--bg:#0f1720;--card:#0b1220;--accent:#5eead4;--muted:#94a3b8}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#071023 0%,var(--bg) 100%);color:#e6eef6;min-height:100vh;display:flex;flex-direction:column}
    header{padding:28px 32px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    main{padding:28px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;align-items:start}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .card h3{margin:0 0 8px 0;font-size:18px}
    .desc{color:var(--muted);font-size:14px;margin-bottom:12px}
  .controls{display:flex;gap:8px;align-items:center}
  .badge-saved{background:#052b22;color:#9ff3d9;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;margin-left:8px}
    button.play{background:var(--accent);color:#042;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    button.open{background:transparent;color:var(--accent);border:1px solid rgba(94,234,212,0.12);padding:6px 10px;border-radius:8px;cursor:pointer}
    .empty{color:var(--muted);grid-column:1/-1;text-align:center;padding:40px}
    footer{margin-top:auto;padding:18px 28px;color:var(--muted);font-size:13px}
    @media (max-width:520px){main{padding:16px;grid-template-columns:1fr}header{padding:18px}}
  </style>
</head>
<body>
  <header>
    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden><rect width="24" height="24" rx="6" fill="#052938"></rect><path d="M6 8h12v2H6zM6 12h12v2H6z" fill="#5eead4"/></svg>
    <h1>Game Selector</h1>
    <div id="userBox" style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <span id="username-display" style="color:var(--muted);font-size:13px"></span>
      <button id="change-username" class="open" style="padding:6px 10px">Change</button>
    </div>
  </header>

  <!-- Username modal -->
  <div id="username-modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.7);backdrop-filter:blur(4px);align-items:center;justify-content:center;z-index:60">
    <div style="background:var(--card);padding:20px;border-radius:12px;max-width:420px;width:90%;box-shadow:0 10px 40px rgba(2,6,23,0.7)">
      <h2 style="margin:0 0 8px 0">Welcome</h2>
      <p style="margin:0 0 12px;color:var(--muted)">Enter a display name that will be passed to games and saved for offline use.</p>
      <div style="display:flex;gap:8px">
        <input id="username-input" placeholder="Your name" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
        <button id="save-username" class="play">Save</button>
      </div>
    </div>
  </div>

  <main id="list">
    <div class="empty">Loading games…</div>
  </main>

  <footer>Games loaded from <code>gamelist.json</code>. Click Play to open the game in a new window.</footer>

  <script>
    // Contract:
    // - Input: GET /gamelist.json (array of {id,name,description,content})
    // - Output: Rendered card elements with Play buttons opening a new window showing the game's HTML content
    // - Errors: graceful message if fetch fails or JSON is empty

    const listEl = document.getElementById('list');

    function createCard(game){
      const wrap = document.createElement('div');
      wrap.className = 'card';

      const h = document.createElement('h3'); h.textContent = game.name; wrap.appendChild(h);
      const p = document.createElement('div'); p.className = 'desc'; p.textContent = game.description || '';
      // if a saved version exists in cookie/localStorage, load it and mark the card
      const saved = loadSavedGame(game.id);
      if(saved){
        // replace content so Play uses the saved offline version
        game.content = saved;
        const badge = document.createElement('span'); badge.className = 'badge-saved'; badge.textContent = 'Saved offline';
        h.appendChild(badge);
      }
      wrap.appendChild(p);

  const controls = document.createElement('div'); controls.className = 'controls';
  const play = document.createElement('button'); play.className = 'play'; play.textContent = 'Play';
  play.addEventListener('click', ()=>openGameWindow(game));
  const openNew = document.createElement('button'); openNew.className='open'; openNew.textContent='Open source';
  openNew.addEventListener('click', ()=>openGameWindow(game, true));
  const dl = document.createElement('button'); dl.className='open'; dl.textContent='Download';
  dl.addEventListener('click', ()=>downloadGame(game));
  const saveCookieBtn = document.createElement('button'); saveCookieBtn.className='open'; saveCookieBtn.textContent='Save (cookie)';
  saveCookieBtn.addEventListener('click', ()=>saveGameToCookie(game));
  controls.appendChild(play); controls.appendChild(openNew); controls.appendChild(dl); controls.appendChild(saveCookieBtn);
      wrap.appendChild(controls);

      return wrap;
    }

    function openGameWindow(game, showSource=false){
      // open a new window and write the content. include a small header when showSource is true.
      // Use a features string that doesn't include 'noopener' or 'noreferrer' so
      // we can obtain a valid Window object and write into it. For security,
      // immediately null out opener to avoid giving the new window a reference
      // back to this page.
      const w = window.open('', '_blank', 'width=900,height=700');
  if(!w) {
        // Popup blocked — fall back to an in-page preview using an iframe.
        const preview = document.createElement('div');
        preview.className = 'card';
        preview.innerHTML = `<h3>${escapeHtml(game.name)} (Preview)</h3><div class="desc">${escapeHtml(game.description||'')}</div><iframe style="width:100%;height:420px;border:1px solid rgba(255,255,255,0.06)" srcdoc="${escapeAttribute(game.content)}"></iframe>`;
        // insert at top so user sees it
        listEl.insertBefore(preview, listEl.firstChild);
        alert('Popup blocked. A preview has been inserted into the page. Allow popups to open the game in a new window.');
        return;
      }
      try{ w.opener = null; } catch(e) { /* ignore if cross-origin restrictions apply */ }
      const doc = w.document;
      // inject username as a global variable into the game's document so games can read window.GAME_USERNAME
      const username = getUsername();
      const injectedPrefix = username ? `<script>window.GAME_USERNAME = ${JSON.stringify(username)};<\/script>` : '';
      if(showSource){
        // show a page with the source html and an iframe to run it
        const escaped = game.content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        doc.open();
        doc.write(`<!doctype html><html><head><meta charset=\"utf-8\"><title>${escapeHtml(game.name)} — Source</title><style>body{font-family:system-ui,Arial;padding:18px;background:#071023;color:#cfeef0}pre{background:#01121b;padding:12px;border-radius:8px;overflow:auto;max-height:60vh}</style></head><body><h1>${escapeHtml(game.name)}</h1><p>${escapeHtml(game.description||'')}</p><h2>Source</h2><pre>${escaped}</pre><h2>Preview</h2><iframe style=\"width:100%;height:40vh;border:1px solid rgba(255,255,255,0.06)\" srcdoc=\"${escapeAttribute(injectedPrefix + game.content)}\"></iframe></body></html>`);
        doc.close();
        return;
      }

      doc.open();
      doc.write(injectedPrefix + (game.content || '<!doctype html><meta charset="utf-8"><body><p>No content provided.</p></body>'));
      doc.close();
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[c]); }
    function escapeAttribute(s){ return (s||'').replace(/&/g,'&amp;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Trigger a download of the game's HTML content as a .html file
    function safeFilename(name){
      return (name||'game').toLowerCase().replace(/[^a-z0-9-_]+/g,'-').replace(/^-+|-+$/g,'') || 'game';
    }

    function downloadGame(game){
      const blob = new Blob([game.content || '<!doctype html><meta charset="utf-8"><body><p>No content provided.</p></body>'], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = safeFilename(game.name) + '.html';
      document.body.appendChild(a);
      a.click();
      a.remove();
      // release the object URL after a short timeout
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }

    // --- username / cookie helpers ---
    function setCookie(name, value, days){
      let s = `${encodeURIComponent(name)}=${encodeURIComponent(value)}`;
      if(days){
        const d = new Date(); d.setTime(d.getTime() + days*24*60*60*1000);
        s += `; expires=${d.toUTCString()}`;
      }
      s += '; path=/';
      document.cookie = s;
    }

    function getCookie(name){
      const re = new RegExp('(?:^|; )' + name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '=([^;]*)');
      const m = document.cookie.match(re);
      return m ? decodeURIComponent(m[1]) : null;
    }

    function setUsername(name){
      try{
        // prefer cookie for portability; also keep a copy in localStorage
        setCookie('gs_username', name, 365);
        localStorage.setItem('gs_username', name);
      }catch(e){
        console.warn('Could not persist username to cookie/localStorage', e);
      }
      updateUsernameDisplay();
    }

    function getUsername(){
      return getCookie('gs_username') || localStorage.getItem('gs_username') || '';
    }

    function updateUsernameDisplay(){
      const el = document.getElementById('username-display');
      const name = getUsername();
      el.textContent = name ? `Hello, ${name}` : '';
    }

    // modal wiring
    (function(){
      const modal = document.getElementById('username-modal');
      const input = document.getElementById('username-input');
      const save = document.getElementById('save-username');
      const change = document.getElementById('change-username');

      change.addEventListener('click', ()=>{ input.value = getUsername() || ''; modal.style.display = 'flex'; input.focus(); });
      save.addEventListener('click', ()=>{ const v = (input.value||'').trim(); if(v){ setUsername(v); modal.style.display='none'; } else { alert('Please enter a name.'); } });

      // show on first load if no username
      if(!getUsername()){
        modal.style.display = 'flex';
        input.focus();
      } else {
        updateUsernameDisplay();
      }
    })();

    // Save game HTML to cookie if small enough, otherwise fall back to localStorage.
    function saveGameToCookie(game){
      const key = `gs_game_${game.id}`;
      const payload = game.content || '';
      // rough safe cookie size limit (per-cookie) — browsers vary; use 4000 bytes as safe cap
      const encoder = new TextEncoder();
      const bytes = encoder.encode(payload).length;
      if(bytes <= 4000){
        try{
          setCookie(key, payload, 365);
          alert(`Saved to cookie as ${key} (${bytes} bytes)`);
          return;
        }catch(e){
          console.warn('cookie set failed', e);
        }
      }
      // fallback to localStorage
      try{
        localStorage.setItem(key, payload);
        alert(`Saved to localStorage as ${key} (${bytes} bytes). Cookie was too small.`);
      }catch(e){
        alert('Failed to save game: storage unavailable or payload too large.');
        console.error(e);
      }
    }

    // load saved game (from cookie or localStorage)
    function loadSavedGame(id){
      const key = `gs_game_${id}`;
      return getCookie(key) || localStorage.getItem(key) || null;
    }

    async function load(){
      try{
        const res = await fetch('gamelist.json', {cache: 'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const arr = await res.json();
        listEl.innerHTML = '';
        if(!Array.isArray(arr) || arr.length===0){
          listEl.innerHTML = '<div class="empty">No games found in <code>gamelist.json</code>.</div>';
          return;
        }
        arr.forEach(game=>{
          const card = createCard(game);
          listEl.appendChild(card);
        });
      }catch(err){
        listEl.innerHTML = `<div class="empty">Failed to load games: ${escapeHtml(err.message||String(err))}</div>`;
        console.error(err);
      }
    }

    load();
  </script>
</body>
</html>
